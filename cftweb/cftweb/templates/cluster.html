{% extends "base.jinja" %}
{% block page_css %}
  <style>
    .col-container {
      width: 100%;
    }
    .scrollable {
      overflow-x: scroll;
    }
    .resizable {
      resize: horizontal;
      float: left;
    }
    .ascii-art {
      /* float: right; */
      font-size: 12px;
	    white-space: pre;
	    font-family: monospace;
    }
    .svg-container text {
      cursor: pointer;
    }
    .seq-mode-link {
      cursor: pointer;
    }
    /* We can make the amino acid alignment a little bigger, since shorter */
    .ascii-art.aa {
      font-size: 15px;
    }


    /* The alignment coloring/styling */
    span.Vgene {
      background-color: #b2d28e
    }
    span.N {
      background-color: #8fbbd9
    }
    span.Dgene {
      background-color: #ecaf80
    }
    span.Jgene {
      background-color: #aba7d4
    }
    span.mutation {
      color: red
    }
    span.CDR3 {
      font-weight: bold
    }

    /* 20-color amino acid colorings from here:
      http://www.imgt.org/IMGTScientificChart/RepresentationRules/colormenu.phpS */
    /* - Arg - Arginine */
    span.aa-r {
      background-color: #E60606
    }
    /* - Lys - Lysine */
    span.aa-k {
     background-color: #C64200
    }
    /* - Gln - Glutamine */
    span.aa-q {
      background-color: #FF6600
    }
    /* - Asn - Asparagine */
    span.aa-n {
      background-color: #FF9900
    }
    /* - Glu - Glutamic Acid */
    span.aa-e {
      background-color: #FFCC00
    }
    /* - Asp - Aspartic Acid */
    span.aa-d {
      background-color: #FFCC99
    }
    /* - His - Histidine */
    span.aa-h {
      background-color: #FFFF99
    }
    /* - Pro - Proline */
    span.aa-p {
      background-color: #FFFF00
    }
    /* - Tyr - Tyrosine */
    span.aa-y {
      background-color: #CCFFCC
    }
    /* - Trp - Tryptophan */
    span.aa-w {
      background-color: #CC99FF
    }
    /* - Ser - Serine */
    span.aa-s {
      background-color: #CCFF99
    }
    /* - Thr - Threonine */
    span.aa-t {
      background-color: #00FF99
    }
    /* - Gly - Glycine */
    span.aa-g {
      background-color: #00FF00
    }
    /* - Ala - Alanine */
    span.aa-a {
      background-color: #CCFFFF
    }
    /* - Met - Methionine */
    span.aa-m {
      background-color: #99CCFF
    }
    /* - Cys - Cysteine */
    span.aa-c {
      background-color: #00FFFF
    }
    /* - Phe - Phenylalanine */
    span.aa-f {
      background-color: #00CCFF
    }
    /* - Leu - Leucine */
    span.aa-l {
      background-color: #3366FF;
      color: white
    }
    /* - Val - Valine */
    span.aa-v {
      background-color: #0000FF;
      color: white
    }
    /* - Ile - Isoleucine */
    span.aa-i {
      background-color: #000080;
      color: white
    }

  </style>
{% endblock %}



{% block content %}

<div class="row">
  <div class="col-md-6">
    <table class="table table-striped">
      <tbody>
        <tr>
          <th>Patient ID</th>
          <td>{{ cluster.pid }}</td>
        </tr>
        <tr>
          <th>Timepoint</th>
          <td>{{ cluster.timepoint }}</td>
        </tr>
        <tr>
          <th>Seed</th>
          <td>{{ cluster.seed }}</td>
        </tr>
        <tr>
          <th>V-gene</th>
          <td>{{ cluster.v_gene }}</td>
        </tr>
        <tr>
          <th>D-gene</th>
          <td>{{ cluster.d_gene }}</td>
        </tr>
        <tr>
          <th>J-gene</th>
          <td>{{ cluster.j_gene }}</td>
        </tr>
        <tr>
          <th>Sequences</th>
          <td>{{ cluster.n_seqs }}</td>
        </tr>
        <tr>
          <th>Clustering step</th>
          <td>{{ cluster.clustering_step }}</td>
        </tr>
        <tr>
          <th>Logprob</th>
          <td>{{ cluster.logprob }}</td>
        </tr>
        <tr>
          <th>All sequences</th>
          <td>
            <a href='{{ url_for('cluster_fasta', id=cluster.id) }}'>Nucleotide</a> &nbsp;
            <a href='{{ url_for('cluster_aa_fasta', id=cluster.id) }}'>Amino Acid</a>
          </td>
        </tr>
        {% if cluster.has_seed %}
        <tr>
          <th>Seed lineage</th>
          <td>
            <a href='{{ url_for('seedlineage_fasta', id=cluster.id) }}'>Nucleotide</a> &nbsp;
            <a href='{{ url_for('seedlineage_aa_fasta', id=cluster.id) }}'>Amino Acid</a>
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>


<h3>Phylogenetic tree</h3>

<div class="row">
  <div class="col-md-12" style="overflow-x: scroll;">
    <figure class="svg-container w80" href="{{ url_for('svg_view', id=cluster.id) }}">
      {{ svg | safe }}
    </figure>
  </div>
</div>


<br/><br/>
<h3>{{focus_node}} lineage alignment</h3>

<div>
  <p>
    <a class="seq-mode-link" data="aa">Amino Acid</a> &nbsp;
    <a class="seq-mode-link" data="dna">Nucleotide</a>
  </p>
  <a href="{{url_for("lineage_download", id=cluster.id, focus_node=focus_node, seq_mode=seq_mode)}}">Download</a>
</div>

<div class="col-container">
  <div class="scrollable resizable" style="width: 10%;">
    <div>&nbsp;</div>
    <div class="ascii-art {{seq_mode}}"> &gt; {{seed_seq.id}} </div>
    <div>&nbsp;</div>
    {% for rec in lineage_seqs %}
    <div class="ascii-art {{seq_mode}}"> &gt; {{rec.id}} </div>
    {% endfor %}
    <div>&nbsp;</div>
  </div>
  <div class="scrollable display-toggle" style="width: auto;">
    <div>&nbsp;</div>
    <div class="ascii-art {{seq_mode}}"> {{seed_seq.seq | annotate(cluster, seq_mode) | safe}} </div>
    <div>&nbsp;</div>
    {% for rec in lineage_seqs %}
    <div class="ascii-art {{seq_mode}}"> {{rec.seq | annotate(cluster, seq_mode) | safe}} </div>
    {% endfor %}
    <div>&nbsp;</div>
  </div>
</div>

<script type="text/javascript">
$(function() {
    // Define a function for updating the query params
    function updateQueryStringParameter(key, value) {
      var currentUrl = window.location.href;
      var re = new RegExp("([?&])" + key + "=.*?(&|$)", "i");
      var separator = currentUrl.indexOf('?') !== -1 ? "&" : "?";
      var newUrl;
      if (currentUrl.match(re)) {
        newUrl = currentUrl.replace(re, '$1' + key + "=" + value + '$2');
      }
      else {
        newUrl = currentUrl + separator + key + "=" + value;
      }
      // Navigate to new url
      location.href = newUrl;
    }

    // When our SVG tree's text nodes are clicks, update the focus_node query param (and reload) so the
    // corresponding lineage is loaded.
    $(".svg-container text").click(function() {
      var nodeName = $(this).html().split(" ")[0];
      console.log("Node clicked for " + nodeName);
      updateQueryStringParameter('focus_node', nodeName);
      // TODO Should add an anchor so we zip down to the alignment...
      });

    // When we click on the seq_mode links, it should toggle the seq_mode query param
    $(".seq-mode-link").click(function() {
      var seqMode = $(this).attr('data');
      console.log("Seq mode link clicked for " + seqMode);
      updateQueryStringParameter('seq_mode', seqMode);
      });

    // want to make the highlighted node bold for easier visual identification
    $(".svg-container text:contains('{{ focus_node }}')").css("font-weight", "bold");
    });
</script>


{% endblock %}

